name: zenodo

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag to upload (e.g. v1.1.0). Leave blank to use latest tag."
        required: false

permissions:
  contents: read

jobs:
  zenodo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: determine tag
        id: tag
        run: |
          git fetch --tags
          if [ -z "${{ inputs.tag }}" ]; then
            TAG=$(git describe --tags "$(git rev-list --tags --max-count=1)")
          else
            TAG=${{ inputs.tag }}
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Uploading tag: $TAG"

      - name: checkout tag
        run: |
          git checkout ${{ steps.tag.outputs.tag }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - run: |
          python -m pip install --upgrade pip build requests
          chmod +x scripts/zenodo_upload.py

      - name: build package
        run: python -m build

      - name: zip source (for Zenodo)
        run: |
          mkdir -p release_assets
          cp -r dist release_assets/
          (cd release_assets && zip -r "source-${{ steps.tag.outputs.tag }}.zip" dist)

      - name: upload to Zenodo
        env:
          ZENODO_TOKEN: ${{ secrets.ZENODO_TOKEN }}
          ZENODO_API_URL: "https://zenodo.org/api"
          ZENODO_DEPOSITION_ID: ${{ vars.ZENODO_DEPOSITION_ID }}
          ZENODO_TITLE: ${{ vars.ZENODO_TITLE }}
          ZENODO_DESCRIPTION: ${{ vars.ZENODO_DESCRIPTION }}
          ZENODO_AUTHORS: ${{ vars.ZENODO_AUTHORS }}
          ZENODO_COMMUNITIES: ${{ vars.ZENODO_COMMUNITIES }}
          ZENODO_KEYWORDS: ${{ vars.ZENODO_KEYWORDS }}
          VERSION: ${{ steps.tag.outputs.tag }}
          FILEPATH: release_assets/source-${{ steps.tag.outputs.tag }}.zip
        run: |
          python scripts/zenodo_upload.py
